<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html" />

<dom-module id="pd-table">
    <link href="pd-table.css" rel="import" type="css"/>
    <style>
        .selected{
            --color-neutral-dark: #f7f7f7;
        }
        .checkboxSelected .head{
            background-color:#edf4fd;
        }
        .selected{
            background-color: var(--color-neutral-dark);
        }
        .alternate tr:nth-child(even){
            background-color: var(--color-neutral-dark);
        }
    </style>
    <template>
        <div class$="{{checkboxSelected}}">
            <div class="head p-t-0-5 p-r-0-5 p-b-1 p-l-1">
                <h2 class="f-left m-0 p-t-0-5 p-l-0-5">
                    <span class="headTitle">{{head}}</span>
                    <span class="headNum">
                        <span>{{numSelected}}</span> selected
                    </span>
                </h2>
                <div class="f-right headOptions p-t-0-1">
                    <div>
                        <paper-icon-button class="f-left" icon="delete" on-click="deleteItems"></paper-icon-button>
                    </div>
                </div>
                <div class="clearfix"></div>
            </div>
            <div id="table" class="table">
                <pd-ui-grid>
                    <pd-ui-grid-item large="2" medium="2" small="2"><paper-checkbox id="toggleAll" on-click="toggleAll"></paper-checkbox></pd-ui-grid-item>
                    <template is="dom-repeat" items="{{headers}}" index-as="key_no">
                        <pd-ui-grid-item large="{{cellGrid(key_no)}}" medium="{{cellGrid(key_no)}}" small="{{cellGrid(key_no)}}">{{item.name}}</pd-ui-grid-item>
                    </template>
                    <div class="clearfix"></div>
                    <template is="dom-repeat" items="{{data}}" class="c-b-b-dark" index-as="key_no">
                        <div class$="{{_computedLineSelected(item.selected)}}" data-itemid$="{{item.id}}">
                            <pd-ui-grid-item custom-class="" large="2" medium="2" small="2">
                                <paper-checkbox checked="{{item.selected}}" on-click="refreshSelectedCheckbox"></paper-checkbox>
                            </pd-ui-grid-item>
                        </div>
                        <div class="clearfix"></div>
                    </template>
                </pd-ui-grid>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "pd-table",
        properties: {
            headers:{
                type:Array,
                value:[],
                notify:true,
                reflectToAttribute:true
            },
            data:{
                type:Array,
                value: function() {
                    return [];
                },
                notify:true,
                reflectToAttribute:true
            },
            dataParams:{
                type:Array,
                value:[],
                notify:true
            },
            templateName:{
                type:String,
                value:"",
                notify:true,
                reflectToAttribute:true
            },
            checkboxSelected:{
                type: String,
                value: "hidden",
                notify: true,
                computed:"_computedCheckboxSelected(numSelected, alternate)"
            },
            numSelected:{
                type:Number,
                value:0,
                notify: true
            },
            alternate:{
                type:Boolean,
                value:true,
                reflectToAttribute:true
            }
        },
        observers: [
            'dataChanged(data.length)'
        ],
        cellGrid:function(key){
            return this.headers[key].grid;
        },
        dataChanged:function(length){
            var self = this;
            self.dataParams = [];
            if(length > 0){
                var item = self.data[0];
                for(var prop in item){
                    self.dataParams.push(prop);
                }
            }
            self.async(function(){
                var templates = self.$.table.querySelectorAll(".tableTemplateWrap");
                for(var j=0;  j <= templates.length - 1; j++){
                    var template = templates[j];
                    var tmpl = template.querySelector(".tableTemplate");
                    if(tmpl == null){
                        tmpl = document.createElement(self.templateName);
                        tmpl.item = self.getItem(template.dataset.itemid);
                        tmpl.className = "tableTemplate";
                        template.insertBefore(tmpl,template.querySelector("pd-ui-grid-item"));
                    }
                    var items = tmpl.querySelectorAll("pd-ui-grid-item");
                    for (var i = 0; i <= items.length - 2; i++) {
                        items[i + 1].large = self.headers[i].grid;
                        items[i + 1].medium = self.headers[i].grid;
                        items[i + 1].small = self.headers[i].grid;
                    }
                }
                self.refreshSelected();
            }, 100);
        },
        getItem:function(id){
            var self = this;
            for(var i=0; i <= self.data.length - 1; i++){
                if(self.data[i].id == id){
                    return self.data[i];
                }
            }
        },
        _computedLineSelected:function(checked){
            if(checked){
                return "tableTemplateWrap p-relative selected";
            }
            return "tableTemplateWrap p-relative ";
        },
        _computedCheckboxSelected:function(numSelected, alternate){
            var classes = [];
            if(numSelected != 0) {
                classes.push("checkboxSelected");
            }
            if(alternate) {
                classes.push("alternate")
            }
            return classes.join(" ");
        },
        deleteItems:function(){
            var self = this;
            var deleteIDs = [];
            for(var i=0;i<=self.data.length-1;i++){
                if(self.data[i].selected){
                    deleteIDs.push(self.data[i].id);
                }
            };
            self.fire('deleteItems',deleteIDs);
        },
        headClicked:function(e){
        },
        refreshSelectedCheckbox:function(){
            this.refreshSelected();
            this.$.toggleAll.checked = false;
        },
        refreshSelected: function(){
            var self = this;
            self.numSelected = 0;
            for(var i=0; i<=self.data.length - 1; i++){
                if(self.data[i].selected){
                    self.numSelected = self.numSelected + 1;
                }
            }
        },
        toggleAll:function(){
            var self = this;
            for(var i=0; i<=self.data.length - 1; i++){
                self.set("data." + i +".selected",self.$.toggleAll.checked);
            }
            self.refreshSelected();
        },
        refreshData:function(){
            var self = this;
            if(self.data != null){
                for(var i=0; i<=self.data.length - 1; i++){
                    self.set("data." + i +".selected",false);
                }
            }
        },
        ready  : function () {
            var self = this;
            this.refreshData();
        }
    });
</script>